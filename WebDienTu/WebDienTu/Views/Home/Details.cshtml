@model WebDienTu.Models.SanPham
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
}

<div class="container py-4">

    <div class="row g-4">
        <!-- Ảnh sản phẩm -->
        <div class="col-md-6 text-center">
            <div class="border rounded shadow-sm p-2 bg-white">
                <img src="@Model.HinhAnh" class="img-fluid rounded" alt="@Model.TenSanPham" style="max-height:400px;" />
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-md-6">
            <h1 class="fw-bold">@Model.TenSanPham</h1>
            <p class="mb-1"><strong>Danh mục:</strong> @Model.MaDanhMucNavigation?.TenDanhMuc</p>
            <p class="mb-1"><strong>Thương hiệu:</strong> @Model.ThuongHieu</p>
            <p class="mb-1"><strong>Xuất xứ:</strong> @Model.XuatXu</p>
            <p class="mb-1"><strong>Bảo hành:</strong> @Model.BaoHanh</p>
            <p class="mb-1"><strong>Mô tả:</strong> @Model.MoTa</p>

            <p class="fs-4 mt-3">
                @if (Model.GiaBan < Model.Gia)
                {
                    <span class="text-muted text-decoration-line-through">@Model.Gia.ToString("N0") VNĐ</span>
                    <span class="text-danger fw-bold ms-2">@Model.GiaBan?.ToString("N0") VNĐ</span>
                }
                else
                {
                    <span class="fw-bold">@Model.Gia.ToString("N0") VNĐ</span>
                }
            </p>

            <!-- Nút hành động -->
            <div class="mt-4 d-flex flex-wrap gap-2">
                @if (User.Identity.IsAuthenticated)
                {
                    <form asp-controller="GioHang" asp-action="AddToCart" method="post" class="d-inline">
                        <input type="hidden" name="sanPhamId" value="@Model.MaSanPham" />
                        <input type="hidden" name="quantity" value="1" />
                        <button type="submit" class="btn btn-success d-flex align-items-center">
                            <i class="fa-solid fa-cart-plus me-2"></i> Thêm vào giỏ
                        </button>
                    </form>

                    <a asp-controller="DonHang" asp-action="ThanhToan" asp-route-id="@Model.MaSanPham" class="btn btn-primary d-flex align-items-center">
                        <i class="fa-solid fa-bolt me-2"></i> Mua ngay
                    </a>


                   @*  <button class="btn btn-outline-danger d-flex align-items-center">
                        <i class="fa-solid fa-heart me-2"></i> Yêu thích
                    </button> *@
                }
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary d-flex align-items-center">
                    <i class="fa-solid fa-arrow-left me-2"></i> Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Thông số sản phẩm (Accordion) -->
    @if (Model.GiaTriThuocTinhs != null && Model.GiaTriThuocTinhs.Any())
    {
        <div class="accordion mt-4 shadow-sm" id="accordionThuocTinh">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingThuocTinh">
                    <button class="accordion-button bg-primary text-white fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThuocTinh" aria-expanded="true" aria-controls="collapseThuocTinh">
                        Thông số sản phẩm
                    </button>
                </h2>
                <div id="collapseThuocTinh" class="accordion-collapse collapse show" aria-labelledby="headingThuocTinh" data-bs-parent="#accordionThuocTinh">
                    <div class="accordion-body p-0">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th style="width:40%">Thuộc tính</th>
                                    <th style="width:60%">Giá trị</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var gt in Model.GiaTriThuocTinhs)
                                {
                                    <tr>
                                        <td>@gt.ThuocTinh?.TenThuocTinh</td>
                                        <td>@gt.GiaTri</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Phần đánh giá -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-warning text-dark fw-bold">
            Đánh giá sản phẩm
        </div>
        <div class="card-body">
            <!-- Trung bình sao -->
            <div class="d-flex align-items-center mb-3">
                <div id="trungBinhSao">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Math.Floor((double)ViewBag.TrungBinhSao))
                        {
                            <i class="fa-solid fa-star text-warning"></i>
                        }
                        else if (i - ViewBag.TrungBinhSao < 1)
                        {
                            <i class="fa-solid fa-star-half-stroke text-warning"></i>
                        }
                        else
                        {
                            <i class="fa-regular fa-star text-warning"></i>
                        }
                    }
                </div>
                <span class="ms-2">(@ViewBag.TrungBinhSao.ToString("0.0") / 5)</span>
            </div>

            <!-- Danh sách bình luận -->
            <div id="danhGiaList" class="mb-3"></div>

            <!-- Form đánh giá -->
            @if (User.Identity.IsAuthenticated)
            {
                <form id="formDanhGia">
                    <input type="hidden" id="MaSanPham" value="@Model.MaSanPham" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Đánh giá:</label>
                        <div id="ratingStars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="fa-regular fa-star text-warning star-select" data-value="@i" style="cursor:pointer; font-size: 1.5rem;"></i>
                            }
                        </div>
                        <input type="hidden" id="SoSao" value="0" />
                    </div>

                    <div class="mb-3">
                        <label for="BinhLuan" class="form-label fw-bold">Bình luận:</label>
                        <textarea id="BinhLuan" class="form-control" rows="3" placeholder="Viết bình luận..."></textarea>
                    </div>

                    <button type="button" id="btnDanhGia" class="btn btn-warning fw-bold">Gửi đánh giá</button>
                </form>
            }
            else
            {
                <p>Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để đánh giá sản phẩm.</p>
            }
        </div>
    </div>
	<!-- Sản phẩm liên quan -->
    <!-- Sản phẩm liên quan -->
    <div class="mt-4">
        <h5 class="mb-3">Sản phẩm liên quan</h5>
        <div id="sanPhamLienQuan"></div>
    </div>



</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var maSanPham = @Model.MaSanPham;

            // Load danh sách bình luận
            $("#danhGiaList").load("/DanhGias/List?maSanPham=" + maSanPham);

            // Chọn sao
            $(document).on("click", ".star-select", function () {
                var value = $(this).data("value");
                $("#SoSao").val(value);
                $(".star-select").removeClass("fa-solid").addClass("fa-regular");
                $(".star-select").each(function () {
                    if ($(this).data("value") <= value) $(this).removeClass("fa-regular").addClass("fa-solid");
                });
            });

            // Gửi đánh giá
            $("#btnDanhGia").click(function () {
                var soSao = $("#SoSao").val();
                var binhLuan = $("#BinhLuan").val();

                $.post("/DanhGias/Create", { maSanPham, soSao, binhLuan }, function (res) {
                    if (res.success) {
                        $("#danhGiaList").load("/DanhGias/List?maSanPham=" + maSanPham);

                        // Cập nhật trung bình sao
                        var trungBinh = res.trungBinh;
                        var html = "";
                        for (var i = 1; i <= 5; i++) {
                            if (i <= Math.floor(trungBinh)) html += '<i class="fa-solid fa-star text-warning"></i>';
                            else if (i - trungBinh < 1) html += '<i class="fa-solid fa-star-half-stroke text-warning"></i>';
                            else html += '<i class="fa-regular fa-star text-warning"></i>';
                        }
                        $("#trungBinhSao").html(html);

                        // Reset form
                        $("#SoSao").val(0);
                        $(".star-select").removeClass("fa-solid").addClass("fa-regular");
                        $("#BinhLuan").val("");
                    } else alert(res.message);
                });
            });
        });
                   $(function () {
            var maSanPham = @Model.MaSanPham;
            var maDanhMuc = @Model.MaDanhMuc;

            $("#sanPhamLienQuan").load("/Home/SanPhamLienQuan?maSanPham=" + maSanPham + "&maDanhMuc=" + maDanhMuc, function () {
                var myCarousel = document.querySelector('#carouselSanPhamLienQuan');
                if (myCarousel) {
                    bootstrap.Carousel.getOrCreateInstance(myCarousel, {
                        interval: 4000,
                        ride: false
                    });
                }
            });
        });


    </script>
}
